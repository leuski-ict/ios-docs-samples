#!/bin/sh

echo "Installing Cocoapod dependencies"
pod install

echo "Fix the bad imports in the generated files"
grep -rl "google/cloud/speech/v1/CloudSpeech.pbobjc.h"  google/** | xargs sed -i '' s@'"google\/cloud\/speech\/v1\/CloudSpeech\.pbobjc\.h"'@'\<googleapis\/CloudSpeech\.pbobjc\.h\>'@g
grep -rl "google/api/Annotations.pbobjc.h"  google/** | xargs sed -i '' s@'"google\/api\/Annotations\.pbobjc\.h"'@'\<googleapis\/Annotations\.pbobjc\.h\>'@g
grep -rl "google/longrunning/Operations.pbobjc.h"  google/** | xargs sed -i '' s@'"google\/longrunning\/Operations\.pbobjc\.h"'@'\<googleapis\/Operations\.pbobjc\.h\>'@g
grep -rl "google/rpc/Status.pbobjc.h"  google/** | xargs sed -i '' s@'"google\/rpc\/Status\.pbobjc\.h"'@'\<googleapis\/Status\.pbobjc\.h\>'@g
grep -rl "google/protobuf/Duration.pbobjc.h"  google/** | xargs sed -i '' s@'"google\/protobuf\/Duration\.pbobjc\.h"'@'\<googleapis\/Duration\.pbobjc\.h>'@g

echo "commenting out #import \"transformations/GRXMappingWriter.h\" in gRPC-RxLibrary-umbrella.h"
sed -i '' s@'^#import "transformations\/GRXMappingWriter\.h"'@'\/\/#import "transformations\/GRXMappingWriter\.h"'@g "Pods/Target Support Files/gRPC-RxLibrary/gRPC-RxLibrary-umbrella.h"
sed -i '' s@'^#import "internal_testing\/GRPCCall+InternalTests\.h"'@'\/\/#import "internal_testing\/GRPCCall+InternalTests\.h"'@g "Pods/Target Support Files/gRPC/gRPC-umbrella.h"

#echo "fix openssl modulemap"
## XCode 9 requires uniqness for module map file names
#mv "Pods/BoringSSL/include/openssl/module.modulemap" "Pods/BoringSSL/include/openssl/BoringSSL.modulemap"

## build it. assume that 'All' target exists, which it is not by default
xcodebuild -project Pods/Pods.xcodeproj -target Pods-Speech -configuration Release-iphoneos -sdk iphoneos
xcodebuild -project Pods/Pods.xcodeproj -target Pods-Speech -configuration Release-iphonesimulator -sdk iphonesimulator


